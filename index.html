<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário Fácil</title>
    <style>
        :root {
		  --panel-width: 300px;
          --panel-offset-right: 20px;
          --cor-fundo: #f8f9fa;
          --cor-superficie: #ffffff;
            --cor-fundo: #f8f9fa;
            --cor-superficie: #ffffff;
            --cor-borda: #dee2e6;
            --cor-texto-principal: #212529;
            --cor-texto-secundario: #6c757d;
            --cor-primaria: #007bff;
            --cor-primaria-hover: #0056b3;
            --cor-sucesso: #28a745;
            --cor-perigo: #dc3545;
            --cor-cabecalho: #343a40;
            --sombra-suave: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background-color:var(--cor-fundo);color:var(--cor-texto-principal);line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:linear-gradient(135deg,#343a40,#495057);color:#fff;padding:30px 20px;text-align:center;margin-bottom:30px;border-radius:12px;position:relative;box-shadow:var(--sombra-suave)}
        .header h1{font-size:2.2rem;margin-bottom:10px;font-weight:700}
        .header p{font-size:1.1rem;opacity:.9}
        .header-actions {
            position: absolute;
            left: 16px;
            right: 16px;
            top: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .screen{display:none;background:var(--cor-superficie);padding:30px;border-radius:12px;box-shadow:var(--sombra-suave)}
        .screen.active{display:block}
        .exam-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
        .exam-card{border:1px solid var(--cor-borda);border-radius:12px;padding:25px;cursor:pointer;transition:all .2s ease-in-out;background-color:var(--cor-superficie);position:relative}
        .exam-card:hover{border-color:var(--cor-primaria);transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1)}
        .exam-card.selected{border-color:var(--cor-sucesso);background-color:#f0fff4;box-shadow:0 0 0 2px rgba(40,167,69,.25)}
        .exam-card h3{color:var(--cor-texto-principal);margin-bottom:10px;font-size:1.2rem;font-weight:600}
        .exam-card p{color:var(--cor-texto-secundario);font-size:.9rem}
        .exam-actions{position:absolute;top:15px;right:15px;display:flex;gap:8px}
        .icon-btn{width:30px;height:30px;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;background:#e9ecef}
        .icon-btn:hover{transform:scale(1.1)}
        .icon-btn.delete{background-color:var(--cor-perigo);color:#fff}
        .icon-btn.edit{background-color:#f39c12;color:#fff}
        .system-section{margin-bottom:30px;border:1px solid var(--cor-borda);border-radius:12px;overflow:hidden;box-shadow:var(--sombra-suave)}
        .system-header{background-color:var(--cor-cabecalho);color:#fff;padding:15px 20px;font-weight:700;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center}
        .system-actions{display:flex;gap:10px}
        .finding-group{background-color:#fff;padding:15px 20px;border-bottom:1px solid var(--cor-borda)}
        .finding-group:last-child{border-bottom:none}
        .finding-group h4{color:var(--cor-texto-principal);margin-bottom:10px;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center;font-weight:600}
        .finding-item{padding:15px 0;border-bottom:1px solid #f0f0f0}
        .finding-item:last-child{border-bottom:none}
        .finding-question{font-weight:500;font-size:1rem}
        .finding-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
        .toggle-button{padding:8px 16px;border:1px solid var(--cor-borda);background-color:var(--cor-superficie);border-radius:8px;cursor:pointer;transition:all .2s ease;font-size:.9rem;font-weight:500}
        .toggle-button:hover{border-color:var(--cor-texto-secundario);background-color:#f1f3f5}
        .toggle-button.active{background-color:var(--cor-sucesso);border-color:var(--cor-sucesso);color:#fff;font-weight:600}
        .button-group{display:flex;gap:15px;margin-top:30px;justify-content:center}
        .btn{padding:12px 30px;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:all .2s ease;font-weight:600;letter-spacing:.5px}
        .btn:hover{transform:translateY(-2px);box-shadow:var(--sombra-suave)}
        .btn-primary{background-color:var(--cor-primaria);color:#fff}
        .btn-primary:hover{background-color:var(--cor-primaria-hover)}
        .btn-secondary{background-color:var(--cor-texto-secundario);color:#fff}
        .btn-success{background-color:var(--cor-sucesso);color:#fff}
        .btn-danger{background-color:var(--cor-perigo);color:#fff}
        .btn-small{padding:6px 12px;font-size:.8rem}
        .result-area{background-color:#f8f9fa;border:1px solid var(--cor-borda);border-radius:8px;padding:20px;margin:20px 0;font-family:'Courier New',monospace;line-height:1.8;white-space:pre-wrap;max-height:400px;overflow-y:auto}
        .preview-panel{position:fixed;right:20px;top:120px;width:300px;background:var(--cor-superficie);border:1px solid var(--cor-borda);border-radius:12px;padding:20px;box-shadow:var(--sombra-suave);max-height:500px;overflow-y:auto}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:5px;font-weight:500}
        .form-group input,.form-group textarea, .form-group select {width:100%;padding:10px;border:1px solid var(--cor-borda);border-radius:8px;font-size:1rem;transition:all .2s ease}
        .form-group input:focus,.form-group textarea:focus, .form-group select:focus {border-color:var(--cor-primaria);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}
        .hidden{display:none}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);animation:fadeIn .3s ease}
        .modal-content{background-color:var(--cor-superficie);margin:5% auto;padding:30px;border-radius:12px;width:80%;max-width:600px;max-height:80vh;overflow-y:auto;animation:slideIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .close{font-size:28px;font-weight:700;cursor:pointer;color:#aaa}
        .category-actions{display:flex;gap:5px;align-items:center}
        .finding-detail-container{display:none;margin-top:10px;width:45%;margin-left:auto}
        .finding-item.has-selection .finding-detail-container{display:block}
        .finding-detail-input{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:.9rem}
        .finding-actions-container{display:none;flex-wrap:wrap;gap:10px;margin-top:10px;padding-top:10px;border-top:1px solid #f0f0f0;justify-content:flex-end}
        .finding-item.has-selection .finding-actions-container{display:flex}
        .action-btn{padding:8px 12px;border-radius:6px;border:1px solid var(--cor-borda);background-color:#f8f8f8;cursor:pointer;font-size:.85rem;font-weight:500;transition:all .2s ease}
        .action-btn:hover{border-color:var(--cor-texto-secundario);transform:translateY(-1px)}
        .action-btn.info-btn{background-color:#eaf5ff;border-color:var(--cor-primaria);color:var(--cor-primaria)}
		.preview-panel {
          position: fixed;
          right: var(--panel-offset-right);
          top: 120px;
          width: var(--panel-width);
          background: #ffffff;
          border: 1px solid #dee2e6;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          max-height: 500px;
          overflow-y: auto;
          transition: transform 0.35s ease-in-out;
          transform: translateX(0);
          z-index: 100;
        }
        .preview-panel.collapsed {
          transform: translateX(calc(var(--panel-width) + var(--panel-offset-right) + 12px));
        }
        .toggle-preview-btn {
          position: fixed;
          top: 140px;
          right: calc(var(--panel-offset-right) + var(--panel-width) + 8px);
          width: 44px;
          height: 44px;
          border-radius: 8px;
          background-color: #ffffff;
          color: var(--cor-primaria);
          border: 1px solid var(--cor-borda);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 6px rgba(0,0,0,0.08);
          z-index: 300;
          transition: right 0.35s ease, background-color .15s ease, transform .15s ease;
        }
        .toggle-preview-btn.collapse-edge {
          right: var(--panel-offset-right);
        }
        .toggle-preview-btn:hover { background-color: #f8f9fa; }
        .answer-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .add-conditional-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--cor-borda);
            background-color: #f1f3f5;
            color: var(--cor-texto-principal);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .add-conditional-btn:hover {
            background-color: #e9ecef;
            transform: scale(1.1);
        }
        .finding-item.conditional {
            margin-left: 25px;
            padding-left: 15px;
            border-left: 3px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Prontuário Fácil</h1>
            <p>Versão 0.0.8</p>
           <div class="header-actions">
                <button class="btn btn-primary btn-small" onclick="openHelpModal()">Ajuda</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-small" onclick="exportData()">Exportar</button>
                    <label class="btn btn-secondary btn-small" style="display:inline-flex;align-items:center;cursor:pointer">Importar<input type="file" accept="application/json" onchange="handleImport(this.files[0])" style="display:none"></label>
                    <button class="btn btn-danger btn-small" onclick="masterReset()">Reset Total</button>
                </div>
            </div>
        </div>

        <div id="screen1" class="screen active">
            <h2>Selecione os Exames</h2>
            <div class="form-group" style="margin-bottom:20px"><input type="text" id="examSearchInput" onkeyup="renderExamSelection()" placeholder="Buscar exame por nome..."></div>
            <div class="exam-grid" id="examGrid"></div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="proceedToExam()">Prosseguir</button>
                <button class="btn btn-secondary" onclick="toggleAddExamForm()">Adicionar Novo Exame</button>
            </div>
            <div id="addExamForm" class="add-exam-form hidden">
                <h3 id="examFormTitle">Adicionar Novo Exame</h3>
                <div class="form-group"><label for="newExamName">Nome:</label><input type="text" id="newExamName"></div>
                <div class="form-group"><label for="newExamDescription">Descrição:</label><input type="text" id="newExamDescription"></div>
                <div class="button-group"><button id="saveExamBtn" class="btn btn-success" onclick="addNewExam()">Adicionar</button><button class="btn btn-secondary" onclick="toggleAddExamForm()">Cancelar</button></div>
            </div>
        </div>

        <div id="screen2" class="screen">
            <h2>Registre os Achados</h2>
            <div id="findingsContainer"></div>
            <div class="button-group"><button class="btn btn-secondary" onclick="backToSelection()">Voltar</button><button class="btn btn-primary" onclick="generateReport()">Gerar Laudo</button></div>
            <button id="togglePreviewBtn" class="toggle-preview-btn" aria-label="Alternar pré-visualização">»</button>
            <div id="previewPanel" class="preview-panel">
                <h3>Pré-visualização</h3>
                <div id="previewContent">Selecione os achados...</div>
            </div>
        </div>

        <div id="screen3" class="screen">
            <h2>Descrição do Exame Físico</h2>
            <div id="resultArea" class="result-area"></div>
            <div class="button-group"><button class="btn btn-success" onclick="copyToClipboard()">Copiar</button><button class="btn btn-primary" onclick="newExam()">Novo Exame</button></div>
        </div>
    </div>

    <div id="findingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="findingModalTitle">Adicionar/Editar Achado</h3><span class="close" onclick="closeFindingModal()">&times;</span></div>
            
            <div class="form-group">
                <label for="findingType">Tipo de Pergunta:</label>
                <select id="findingType" onchange="updateFindingModalUI()">
                    <option value="multiple-choice">Múltipla Escolha / Sim-Não</option>
                    <option value="open-text">Texto Aberto (ex: Sinais Vitais)</option>
                </select>
            </div>

            <div class="form-group"><label for="findingQuestion">Pergunta:</label><input type="text" id="findingQuestion" placeholder="Ex: Bulhas cardíacas? ou Frequência Cardíaca"></div>
            
            <div class="form-group" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="conditionalCheckbox" onclick="toggleConditionalUI()">
                    <strong>Exibição Condicional</strong>
                </label>
                <div id="conditionalControls" class="hidden" style="margin-top: 10px; padding-left: 20px;">
                    <p style="font-size: 0.9em; color: #6c757d;">Exibir este achado somente se:</p>
                    <div class="form-group">
                        <label for="triggerFindingSelect">A resposta para o achado...</label>
                        <select id="triggerFindingSelect" class="form-control" style="width:100%; padding:8px;"></select>
                    </div>
                    <div class="form-group">
                        <label for="triggerAnswerSelect">...for igual a...</label>
                        <select id="triggerAnswerSelect" class="form-control" style="width:100%; padding:8px;"></select>
                    </div>
                </div>
            </div>
            <div id="reportLabelGroup" class="form-group hidden">
                <label for="findingReportLabel">Etiqueta para o Laudo (ex: FC):</label>
                <input type="text" id="findingReportLabel" placeholder="Ex: FC, PA, FR, SpO2">
            </div>

            <div id="answersGroup">
                <div class="form-group">
                    <label>Respostas Possíveis:</label>
                    <div id="answersContainer"></div>
                    <button class="btn btn-secondary btn-small" onclick="addAnswerField()" style="margin-top:10px">+ Adicionar Resposta</button>
                </div>
            </div>

            <div class="form-group"><label for="findingInfo">Texto de Informação (Opcional):</label><textarea id="findingInfo" rows="4" placeholder="Explique o que é este achado..."></textarea></div>
            <div class="button-group"><button id="saveFindingBtn" class="btn btn-success">Salvar</button><button class="btn btn-secondary" onclick="closeFindingModal()">Cancelar</button></div>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Informações sobre o Achado</h3><span class="close" onclick="closeInfoModal()">&times;</span></div>
            <div id="infoModalContent" style="white-space:pre-wrap;line-height:1.7"></div>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Como Usar o Prontuário Fácil</h3>
                <span class="close" onclick="closeHelpModal()">&times;</span>
            </div>
            <div id="helpModalContent" style="line-height:1.7">
                <h4>Passo 1: Selecione os Exames</h4>
                <p>Na tela inicial, clique nos roteiros de examinação que deseja incluir na sua consulta. Os exames selecionados ficarão destacados. Você pode adicionar seus próprios exames customizados clicando em "Adicionar Novo Exame" (não recomendamos).</p>
                
                <h4>Passo 2: Registre os Achados</h4>
                <p>Após selecionar os exames e clicar em "Prosseguir", você verá uma lista de seções e perguntas para cada exame. Clique nos botões (ex: "Sim", "Não") para registrar suas observações. Para perguntas de texto (como Sinais Vitais), basta digitar o valor no campo correspondente.</p>
                <p>À direita, um painel de pré-visualização mostrará o laudo sendo montado em tempo real.</p>
                
                <h4>Passo 3: Gere e Copie o Laudo</h4>
                <p>Quando terminar de registrar os achados, clique em "Gerar Laudo". O texto final será apresentado. Você pode então clicar em "Copiar" para transferir o laudo para a área de transferência e colar onde precisar.</p>

                <hr style="margin: 20px 0;">

                <h4>Recursos Adicionais:</h4>
                <ul style="padding-left: 20px;">
                    <li><strong>Adicionar Achados:</strong> Dentro de um exame, na tela de registro, você pode adicionar perguntas customizadas (achados) a qualquer seção clicando no botão "+".</li>
                    <li><strong>Importar/Exportar:</strong> Use os botões no cabeçalho para salvar ("Exportar") suas configurações de exames e achados customizados em um arquivo. Você pode carregar ("Importar") esse arquivo em outro computador ou navegador para ter seus dados sempre à mão.</li>
                    <li><strong>Limpar Sessão:</strong> Este botão apaga os exames e achados selecionados na sua sessão atual, permitindo começar um novo laudo do zero.</li>
                </ul>
            </div>
        </div>
    </div>

<script src="dadosNativos.js"></script>

<script> 

// Adicione esta NOVA função ao seu script (e apague a isParentOfAnsweredBranch)
/**
 * Constrói uma frase completa para um "branch" de respostas, de forma recursiva.
 * @param {Object} currentFinding - O achado inicial do branch (o "pai").
 * @param {Array} allExamFindings - A lista completa de todos os achados do exame.
 * @param {Object} currentState - O objeto findingsState com todas as respostas.
 * @returns {string} - A frase completa e concatenada do branch.
 */
function buildBranchSentence(currentFinding, allExamFindings, currentState) {
    const state = currentState[currentFinding.id];
    if (!state) return ''; // Segurança: não deveria acontecer se chamado corretamente

    const answer = (currentFinding.answers || []).find(a => a.id === state.answerId);
    if (!answer) return '';

    let sentenceParts = [answer.description || answer.text];

    // Encontra todos os filhos DIRETOS que foram respondidos
    const answeredChildren = allExamFindings.filter(f =>
        f.displayCondition &&
        f.displayCondition.triggerFindingId === currentFinding.id &&
        currentState[f.id]
    );

    // Para cada filho, chama a função novamente para construir o resto da frase
    for (const child of answeredChildren) {
        sentenceParts.push(buildBranchSentence(child, allExamFindings, currentState));
    }

    // Junta as partes: o texto do pai + o texto de cada filho/neto branch.
    return sentenceParts.join(' ');
}


// ======== ESTADO DA APLICAÇÃO ========
let selectedExams = [];
let findingsState = {};
let customExams = {};
let customAdditions = {};
let likelihoodData = {};

// ======== INICIALIZAÇÃO ========
document.addEventListener('DOMContentLoaded', function() {
    loadCustomData();
    renderExamSelection();
    loadSessionState();
    const panel = document.getElementById('previewPanel');
    const btn = document.getElementById('togglePreviewBtn');
    if (panel && btn) {
        panel.classList.remove('collapsed');
        btn.textContent = '»';
        btn.title = 'Ocultar pré-visualização';
        btn.addEventListener('click', togglePreviewPanel);
        positionPreviewToggle();
        window.addEventListener('resize', positionPreviewToggle);
    }
});

// ======== NAVEGAÇÃO E LÓGICA DE TELAS ========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    setTimeout(positionPreviewToggle, 30);
}

function proceedToExam() {
    if (selectedExams.length === 0) {
        alert('Selecione pelo menos um exame.');
        return;
    }
    renderFindings();
    showScreen('screen2');
}

function backToSelection() {
    showScreen('screen1');
}


function generateReportText() {
    const finalReportLines = [];
    selectedExams.forEach(examId => {
        const exam = getExamWithAdditions(examId);
        if (!exam) return;

        const allExamFindings = Object.values(exam.findings).flatMap(cat => cat.items || []);
        const examSectionLines = [];

        Object.values(exam.findings).forEach(category => {
            const sentenceFindings = [];
            const lineFindings = [];
            
            const sortedItems = reorderFindings(category.items || []);

            sortedItems.forEach(finding => {
                const state = findingsState[finding.id];
                if (!state) return;

                // ================== INÍCIO DA LÓGICA FINAL ==================
                // A REGRA AGORA É: só processamos um achado se ele for o INÍCIO de uma frase.
                // Um achado é o início de uma frase se ele NÃO for filho de outro achado JÁ RESPONDIDO.
                if (finding.displayCondition && findingsState[finding.displayCondition.triggerFindingId]) {
                    // Este é um filho de um pai respondido, então ele será processado junto com o pai. Pula.
                    return; 
                }
                // =================== FIM DA LÓGICA FINAL ===================

                if (finding.type === 'open-text' && state.value) {
                    lineFindings.push(`${finding.reportLabel}: ${state.value}.`);
                } else if (state.answerId !== undefined) {
                    // Se chegamos aqui, este é o "início" de um branch.
                    // Mandamos a nova função construir a frase inteira para este branch.
                    const fullSentence = buildBranchSentence(finding, allExamFindings, findingsState);
                    
                    if (state.detail) {
                        sentenceFindings.push(`${fullSentence} (${state.detail})`);
                    } else {
                        sentenceFindings.push(fullSentence);
                    }
                }
            });

            if (sentenceFindings.length === 0 && lineFindings.length === 0) return; 

          if (sentenceFindings.length > 0) {
                // Mapeia os achados para converter para minúscula os que não são o primeiro da lista.
                const finalSentence = sentenceFindings.map((sentence, index) => {
                    // Se não for o primeiro, e começar com letra maiúscula, converte.
                    if (index > 0 && sentence && sentence.charAt(0) === sentence.charAt(0).toUpperCase() && sentence.charAt(0).toLowerCase() !== sentence.charAt(0)) {
                        return sentence.charAt(0).toLowerCase() + sentence.slice(1);
                    }
                    return sentence;
                }).join(', ');

                // Garante que a primeira letra da frase final (já concatenada) seja maiúscula.
                examSectionLines.push(`${category.name}: ${finalSentence.charAt(0).toUpperCase() + finalSentence.slice(1)}.`);
            }
            if (lineFindings.length > 0) {
                if (sentenceFindings.length === 0) examSectionLines.push(`${category.name}:`);
                lineFindings.forEach(line => examSectionLines.push(`  ${line}`));
            }
        });

        if (examSectionLines.length > 0) {
            finalReportLines.push(`**${exam.name}:**`);
            finalReportLines.push(...examSectionLines);
            finalReportLines.push('');
        }
    });
    return finalReportLines.join('\n').trim();
}

function generateReport() {
    let reportText = generateReportText();
    reportText = reportText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    reportText = reportText.replace(/\n/g, '<br>');
    document.getElementById('resultArea').innerHTML = reportText;
    showScreen('screen3');
}
function newExam() { selectedExams = []; findingsState = {}; likelihoodData = {}; masterReset(); showScreen('screen1'); renderExamSelection(); }
function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('resultArea').textContent).then(() => alert('Copiado!')); }

// ======== LÓGICA DE DADOS (MERGE E BUSCA) ========
function getExamWithAdditions(examId) {
    if (customExams[examId]) return customExams[examId];
    const base = examsData[examId];
    if (!base) return null;
    const additions = customAdditions[examId];
    if (!additions) return base;
    const merged = JSON.parse(JSON.stringify(base));
    Object.entries(additions).forEach(([catKey, addCat]) => {
        if (!merged.findings[catKey]) {
            merged.findings[catKey] = { name: addCat.name || 'Categoria Personalizada', items: [] };
        }
        merged.findings[catKey].items.push(...addCat.items);
    });
    return merged;
}

function findFindingById(id) {
    const allExams = { ...examsData, ...customExams };
    for (const exam of Object.values(allExams)) {
        for (const cat of Object.values(exam.findings)) {
            const f = (cat.items || []).find(i => i.id === id);
            if (f) return f;
        }
    }
    for (const examId in customAdditions) {
        for (const cat of Object.values(customAdditions[examId])) {
            const f = (cat.items || []).find(i => i.id === id);
            if (f) return f;
        }
    }
    return null;
}

// ======== TELA 1: SELEÇÃO DE EXAMES ========
function renderExamSelection() {
    const grid = document.getElementById('examGrid');
    grid.innerHTML = '';
    const allExams = { ...examsData, ...customExams };
    const filterText = (document.getElementById('examSearchInput')?.value || '').toLowerCase();
    const filtered = Object.values(allExams).filter(exam => exam.name.toLowerCase().includes(filterText));
    filtered.forEach(exam => {
        const card = document.createElement('div');
        card.className = 'exam-card';
        if (selectedExams.includes(exam.id)) card.classList.add('selected');
        const isCustom = exam.id.startsWith('custom_');
        card.innerHTML = `<h3>${exam.name}</h3><p>${exam.description}</p>${isCustom ? `<div class="exam-actions"><button class="icon-btn edit" onclick="openEditExamForm('${exam.id}')" title="Editar">✎</button><button class="icon-btn delete" onclick="deleteExam('${exam.id}')" title="Deletar">×</button></div>` : ''}`;
        card.onclick = (e) => { if (!e.target.closest('.exam-actions')) toggleExamSelection(exam.id); };
        grid.appendChild(card);
    });
}
function toggleExamSelection(examId) { const index = selectedExams.indexOf(examId); if (index > -1) { selectedExams.splice(index, 1); } else { selectedExams.push(examId); } renderExamSelection(); }

// ======== TELA 2: RENDERIZAÇÃO DOS ACHADOS ========
// APAGUE sua função renderFindings antiga e COLE esta no lugar.
function renderFindings() {
    const container = document.getElementById('findingsContainer');
    container.innerHTML = '';
    selectedExams.forEach(examId => {
        const exam = getExamWithAdditions(examId);
        if (!exam) return;
        const isCustomExam = exam.id.startsWith('custom_');
        const systemSection = document.createElement('div');
        systemSection.className = 'system-section';
        const header = document.createElement('div');
        header.className = 'system-header';
        header.innerHTML = `${exam.name}<div class="system-actions">${isCustomExam ? `<button class="btn btn-secondary btn-small" onclick="addCategory('${examId}')">+ Seção</button>` : ''}<button class="btn btn-success btn-small" onclick="openFindingModal('${examId}')">+ Achado</button></div>`;
        systemSection.appendChild(header);
        Object.entries(exam.findings).forEach(([categoryKey, category]) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'finding-group';
            const groupTitle = document.createElement('h4');
            groupTitle.innerHTML = `<span>${category.name}</span><div class="category-actions">${isCustomExam ? `<button class="icon-btn edit btn-small" onclick="editCategoryName('${examId}','${categoryKey}')" title="Renomear Seção">✎</button><button class="icon-btn delete btn-small" onclick="deleteCategory('${examId}','${categoryKey}')" title="Deletar Seção">×</button>` : ''}<button class="btn btn-success btn-small" onclick="openFindingModal('${examId}','${categoryKey}')">+</button></div>`;
            groupDiv.appendChild(groupTitle);
            
            // ===== INÍCIO DA ALTERAÇÃO =====
            // Pega a lista original de achados
            const originalItems = category.items || [];
            // Usa nossa nova função para criar uma lista ordenada
            const sortedItems = reorderFindings(originalItems);
            
            // Itera sobre a lista ORDENADA
            sortedItems.forEach(finding => {
            // ===== FIM DA ALTERAÇÃO =====
                if (finding.displayCondition) {
                    const parentState = findingsState[finding.displayCondition.triggerFindingId];
                    if (!parentState || parentState.answerId !== finding.displayCondition.triggerAnswerId) {
                        return;
                    }
                }

                const stateObj = findingsState[finding.id];
                const hasSelection = stateObj && (stateObj.answerId !== undefined || stateObj.value);
                
                const findingWrapper = document.createElement('div');
                findingWrapper.className = 'finding-item';
                findingWrapper.id = `finding-item-${finding.id}`;
                if (hasSelection) findingWrapper.classList.add('has-selection');

                if (finding.displayCondition) {
                    findingWrapper.classList.add('conditional');
                }

                const questionDiv = document.createElement('div');
                questionDiv.className = 'finding-question';
                questionDiv.textContent = finding.question;
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'finding-controls';

                if (finding.type === 'open-text') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'finding-detail-input';
                    input.placeholder = 'Insira o valor...';
                    input.style.maxWidth = '200px';
                    input.value = findingsState[finding.id]?.value || '';
                    input.oninput = (e) => saveOpenTextAnswer(finding.id, e.target.value);
                    controlsDiv.appendChild(input);
                } else {
                    (finding.answers || []).forEach(answer => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'answer-wrapper';

                        const btn = document.createElement('button');
                        btn.className = 'toggle-button';
                        btn.textContent = answer.text;
                        if (stateObj && stateObj.answerId === answer.id) {
                            btn.classList.add('active');
                        }
                        btn.onclick = () => selectAnswer(finding.id, answer.id);
                        
                        const addBtn = document.createElement('button');
                        addBtn.className = 'add-conditional-btn';
                        addBtn.title = `Adicionar achado condicional para a resposta "${answer.text}"`;
                        addBtn.innerHTML = '+';
                        addBtn.onclick = (e) => {
                            e.stopPropagation();
                            openConditionalFindingModal(exam.id, categoryKey, finding.id, answer.id);
                        };

                        wrapper.appendChild(btn);
                        wrapper.appendChild(addBtn);
                        controlsDiv.appendChild(wrapper);
                    });
                }
                
                if (finding.id.startsWith('custom_')) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-btn edit'; editBtn.innerHTML = '✎'; editBtn.title = 'Editar achado';
                    editBtn.onclick = () => openEditFindingModal(exam.id, categoryKey, finding.id);
                    controlsDiv.appendChild(editBtn);
                }

                const detailContainer = document.createElement('div');
                detailContainer.className = 'finding-detail-container';

                if (finding.type !== 'open-text') {
                    const detailInput = document.createElement('input');
                    detailInput.type = 'text'; 
                    detailInput.className = 'finding-detail-input';
                    detailInput.placeholder = 'Adicionar detalhes (opcional)...';
                    detailInput.value = stateObj?.detail || '';
                    detailInput.oninput = (e) => saveFindingDetail(e, finding.id);
                    detailContainer.appendChild(detailInput);
                }
                
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'finding-actions-container';
                
                const hasHardcodedLRs = (finding.answers || []).some(ans => ans.lr !== undefined);

                if (finding.type === 'yes-no' && hasHardcodedLRs) {
                     actionsContainer.innerHTML = `
                        <button class="action-btn" disabled>LR+ : <strong>${finding.answers[0]?.lr !== undefined ? finding.answers[0].lr : 'N/A'}</strong></button>
                        <button class="action-btn" disabled>LR– : <strong>${finding.answers[1]?.lr !== undefined ? finding.answers[1].lr : 'N/A'}</strong></button>
                    `;
                } else if (!hasHardcodedLRs && finding.type !== 'open-text') {
                    const lrPositive = likelihoodData[finding.id]?.positive;
                    const lrNegative = likelihoodData[finding.id]?.negative;
                    actionsContainer.innerHTML = `
                        <button class="action-btn" onclick="toggleLikelihood('${finding.id}', 'positive')">LR+ : <strong>${lrPositive !== undefined ? lrPositive : 'N/A'}</strong></button>
                        <button class="action-btn" onclick="toggleLikelihood('${finding.id}', 'negative')">LR– : <strong>${lrNegative !== undefined ? lrNegative : 'N/A'}</strong></button>
                    `;
                }
                
                if (finding.info) {
                    actionsContainer.innerHTML += `<button class="action-btn info-btn" onclick="showInfoModal('${finding.id}')">ⓘ Informações</button>`;
                }

                findingWrapper.appendChild(questionDiv);
                findingWrapper.appendChild(controlsDiv);
                findingWrapper.appendChild(detailContainer);
                findingWrapper.appendChild(actionsContainer);
                groupDiv.appendChild(findingWrapper);
            });
            systemSection.appendChild(groupDiv);
        });
        container.appendChild(systemSection);
    });
    updatePreview();
}

function selectAnswer(findingId, answerId) {
    const currentState = findingsState[findingId];
    if (currentState && currentState.answerId === answerId) {
        delete findingsState[findingId];
    } else {
        findingsState[findingId] = { answerId: answerId, detail: currentState?.detail || '' };
    }
    renderFindings();
}

function openConditionalFindingModal(examId, categoryKey, triggerFindingId, triggerAnswerId) {
    const condition = {
        triggerFindingId: triggerFindingId,
        triggerAnswerId: triggerAnswerId
    };
    openFindingModal(examId, categoryKey, condition);
}

function saveFindingDetail(event, findingId) {
    if (findingsState[findingId]) {
        findingsState[findingId].detail = event.target.value;
        updatePreview();
        saveSessionState();
    }
}

function toggleLikelihood(findingId, type) {
    if (!likelihoodData[findingId]) likelihoodData[findingId] = {};
    const currentValue = likelihoodData[findingId][type];
    const value = prompt(`Insira o valor da LR ${type === 'positive' ? 'positiva' : 'negativa'}:`, currentValue || '');
    if (value === null) return;
    if (value.trim() === '') {
        delete likelihoodData[findingId][type];
    } else if (!isNaN(value) && value.trim() !== '') {
        likelihoodData[findingId][type] = parseFloat(value);
    }
    saveCustomData();
    renderFindings();
}

function saveOpenTextAnswer(findingId, value) {
    if (value.trim() !== '') {
        findingsState[findingId] = { value: value.trim() };
    } else {
        delete findingsState[findingId];
    }
    updatePreview();
    saveSessionState();
}

// ======== MODAIS (ADICIONAR/EDITAR) ========
function addAnswerField(text = '', description = '') {
    const container = document.getElementById('answersContainer');
    const div = document.createElement('div');
    div.className = 'answer-input-group';
    div.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px;';
    const textInput = document.createElement('input');
    textInput.type = 'text'; textInput.value = text; textInput.placeholder = 'Texto do Botão'; textInput.className = 'answer-text';
    const descInput = document.createElement('input');
    descInput.type = 'text'; descInput.value = description; descInput.placeholder = 'Texto para o Laudo (Descrição)'; descInput.className = 'answer-description';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn-danger btn-small'; removeBtn.textContent = '×';
    removeBtn.onclick = () => div.remove();
    div.appendChild(textInput); div.appendChild(descInput); div.appendChild(removeBtn);
    container.appendChild(div);
}

function openFindingModal(examId, categoryKey = null, condition = null) {
    const modal = document.getElementById('findingModal');
    delete modal.dataset.condition;

    document.getElementById('findingType').value = 'multiple-choice';
    document.getElementById('findingQuestion').value = '';
    document.getElementById('findingReportLabel').value = '';
    document.getElementById('answersContainer').innerHTML = '';
    document.getElementById('findingInfo').value = '';
    addAnswerField('Sim', ''); 
    addAnswerField('Não', '');
    document.getElementById('findingModalTitle').textContent = 'Adicionar Novo Achado';
    document.getElementById('saveFindingBtn').onclick = () => saveFinding({ examId, categoryKey });

    const conditionalCheckbox = document.getElementById('conditionalCheckbox');
    const conditionalControls = document.getElementById('conditionalControls');
    conditionalCheckbox.checked = false;
    conditionalControls.classList.add('hidden');
    
    if (condition) {
        modal.dataset.condition = JSON.stringify(condition);
        document.getElementById('findingModalTitle').textContent = 'Adicionar Achado Condicional';
        conditionalCheckbox.checked = true;
        conditionalControls.classList.remove('hidden');

        const triggerFindingSelect = document.getElementById('triggerFindingSelect');
        const triggerAnswerSelect = document.getElementById('triggerAnswerSelect');
        
        triggerFindingSelect.innerHTML = '';
        triggerAnswerSelect.innerHTML = '';

        const parentFinding = findFindingById(condition.triggerFindingId);
        if (parentFinding) {
            const findingOption = new Option(parentFinding.question, parentFinding.id, true, true);
            triggerFindingSelect.add(findingOption);
            
            const triggerAnswer = (parentFinding.answers || []).find(a => a.id === condition.triggerAnswerId);
            if (triggerAnswer) {
                const answerOption = new Option(triggerAnswer.text, triggerAnswer.id, true, true);
                triggerAnswerSelect.add(answerOption);
            }
        }
        
        triggerFindingSelect.disabled = true;
        triggerAnswerSelect.disabled = true;
    } else {
        document.getElementById('triggerFindingSelect').innerHTML = '<option>--Selecione--</option>';
        document.getElementById('triggerAnswerSelect').innerHTML = '<option>--Selecione--</option>';
        document.getElementById('triggerFindingSelect').disabled = false;
        document.getElementById('triggerAnswerSelect').disabled = false;
    }
    
    updateFindingModalUI();
    modal.style.display = 'block';
}

function openEditFindingModal(examId, categoryKey, findingId) {
    let currentFinding = { examId, categoryKey, findingId };
    const finding = findFindingById(findingId);
    if (!finding) return;
    document.getElementById('findingQuestion').value = finding.question;
    document.getElementById('findingInfo').value = finding.info || '';
    const answersContainer = document.getElementById('answersContainer');
    answersContainer.innerHTML = '';
    (finding.answers || []).forEach(ans => addAnswerField(ans.text, ans.description));
    document.getElementById('findingModalTitle').textContent = 'Editar Achado';
    document.getElementById('saveFindingBtn').onclick = () => saveFindingChanges(currentFinding);
    document.getElementById('findingModal').style.display = 'block';
}

function closeFindingModal() {
    const modal = document.getElementById('findingModal');
    delete modal.dataset.condition; 
    modal.style.display = 'none';
}

function saveFinding(currentFinding) {
    const { examId, categoryKey } = currentFinding;
    const type = document.getElementById('findingType').value;
    const question = document.getElementById('findingQuestion').value.trim();
    const info = document.getElementById('findingInfo').value.trim();
    const reportLabel = document.getElementById('findingReportLabel').value.trim();

    if (!question) return alert('A pergunta é obrigatória.');

    let newFinding;

    if (type === 'open-text') {
        if (!reportLabel) return alert('A etiqueta para o laudo é obrigatória para perguntas de texto aberto.');
        newFinding = { id: 'custom_' + Date.now(), question, type: 'open-text', reportLabel, info };
    } else {
        const answerGroups = document.querySelectorAll('#answersContainer .answer-input-group');
        if (answerGroups.length === 0) return alert('Respostas são obrigatórias.');
        const answers = Array.from(answerGroups).map(div => ({
            id: `ans_${Date.now()}_${Math.random()}`,
            text: div.querySelector('.answer-text').value.trim(),
            description: div.querySelector('.answer-description').value.trim()
        })).filter(ans => ans.text);
        if (answers.length === 0) return alert('Preencha o texto de pelo menos uma resposta.');
        newFinding = {
            id: 'custom_' + Date.now(), question, answers, info,
            type: answers.length > 2 || answers.some(a => !['sim', 'não'].includes(a.text.toLowerCase())) ? 'multiple-choice' : 'yes-no'
        };
    }

    const modal = document.getElementById('findingModal');
    if (modal.dataset.condition) {
        newFinding.displayCondition = JSON.parse(modal.dataset.condition);
    }
    
    // ================== LÓGICA DE INSERÇÃO CORRIGIDA ==================
    const insertFinding = (itemsArray, findingToInsert) => {
        if (findingToInsert.displayCondition) {
            const parentId = findingToInsert.displayCondition.triggerFindingId;
            const parentIndex = itemsArray.findIndex(item => item.id === parentId);
            if (parentIndex > -1) {
                itemsArray.splice(parentIndex + 1, 0, findingToInsert);
                return; // Inserido com sucesso, sai da função
            }
        }
        // Se não for condicional ou se o pai não for encontrado, adiciona no final
        itemsArray.push(findingToInsert);
    };

    if (examId.startsWith('custom_')) {
        const exam = customExams[examId];
        const catKey = categoryKey || 'cat_' + Date.now();
        if (!exam.findings[catKey]) {
            exam.findings[catKey] = { name: "Categoria Personalizada", items: [] };
        }
        insertFinding(exam.findings[catKey].items, newFinding);

    } else {
        if (!customAdditions[examId]) customAdditions[examId] = {};
        const catKey = categoryKey || 'cat_' + Date.now();
        if (!customAdditions[examId][catKey]) {
            customAdditions[examId][catKey] = { name: "Achados Adicionados", items: [] };
        }
        insertFinding(customAdditions[examId][catKey].items, newFinding);
    }
    // ================== FIM DA CORREÇÃO ==================

    saveCustomData();
    closeFindingModal();
    renderFindings();
}

function saveFindingChanges(currentFinding) {
    const { examId, findingId } = currentFinding;
    const finding = findFindingById(findingId);
    if (!finding) return;
    finding.question = document.getElementById('findingQuestion').value.trim();
    finding.info = document.getElementById('findingInfo').value.trim();
    const answerGroups = document.querySelectorAll('#answersContainer .answer-input-group');
    const answers = Array.from(answerGroups).map(div => ({
        id: `ans_${Date.now()}_${Math.random()}`,
        text: div.querySelector('.answer-text').value.trim(),
        description: div.querySelector('.answer-description').value.trim()
    })).filter(ans => ans.text && ans.description);
    
    finding.answers = answers;
    finding.type = answers.length > 2 || answers.some(a => !['sim', 'não'].includes(a.text.toLowerCase())) ? 'multiple-choice' : 'yes-no';
    
    saveCustomData();
    closeFindingModal();
    renderFindings();
}

function toggleConditionalUI() {
    const checkbox = document.getElementById('conditionalCheckbox');
    const controls = document.getElementById('conditionalControls');
    if (checkbox.checked) {
        controls.classList.remove('hidden');
    } else {
        controls.classList.add('hidden');
    }
}

function showInfoModal(findingId) {
    const finding = findFindingById(findingId);
    const infoText = finding?.info;
    if (!infoText || !infoText.trim()) { alert("Nenhuma informação adicional disponível."); return; }
    document.getElementById('infoModalContent').innerHTML = infoText;
    document.getElementById('infoModal').style.display = 'block';
}

function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; }

function openHelpModal() {
    document.getElementById('helpModal').style.display = 'block';
}

function closeHelpModal() {
    document.getElementById('helpModal').style.display = 'none';
}

// ======== LAUDO ========
function updatePreview() { document.getElementById('previewContent').textContent = generateReportText() || 'Selecione...'; }


// ======== EXAMES E CATEGORIAS CUSTOMIZADOS ========
function toggleAddExamForm() { document.getElementById('addExamForm').classList.toggle('hidden'); }
function addNewExam() { const name = document.getElementById('newExamName').value.trim(); const desc = document.getElementById('newExamDescription').value.trim(); if (!name || !desc) return; const id = 'custom_' + Date.now(); customExams[id] = { id, name, description: desc, findings: { personalizado: { name: "Personalizado", items: [] } } }; saveCustomData(); toggleAddExamForm(); renderExamSelection(); }
function deleteExam(examId) { if(confirm('Deletar este exame e todos os seus achados?')){ delete customExams[examId]; selectedExams = selectedExams.filter(id => id !== examId); saveCustomData(); renderExamSelection(); }}
function addCategory(examId) { const name = prompt("Nome da nova seção:"); if (name) { const catKey = 'cat_' + Date.now(); customExams[examId].findings[catKey] = { name, items: [] }; saveCustomData(); renderFindings(); }}
function editCategoryName(examId, catKey) { const newName = prompt("Novo nome:", customExams[examId].findings[catKey].name); if (newName) { customExams[examId].findings[catKey].name = newName; saveCustomData(); renderFindings(); }}
function deleteCategory(examId, catKey) { const cat = customExams[examId].findings[catKey]; if(confirm(`Deletar a seção "${cat.name}" e seus ${cat.items.length} achados?`)){ delete customExams[examId].findings[catKey]; saveCustomData(); renderFindings(); }}

// ======== PERSISTÊNCIA ========
function saveCustomData() {
    localStorage.setItem('customExams', JSON.stringify(customExams));
    localStorage.setItem('customAdditions', JSON.stringify(customAdditions));
    localStorage.setItem('likelihoodData', JSON.stringify(likelihoodData));
}
function loadCustomData() {
    const ce = localStorage.getItem('customExams'); if(ce) customExams = JSON.parse(ce);
    const ca = localStorage.getItem('customAdditions'); if(ca) customAdditions = JSON.parse(ca);
    const ld = localStorage.getItem('likelihoodData'); if(ld) likelihoodData = JSON.parse(ld);
}
function saveSessionState() { sessionStorage.setItem('sessionState', JSON.stringify({ selectedExams, findingsState })); }
function loadSessionState() { const s = sessionStorage.getItem('sessionState'); if (s) { const d = JSON.parse(s); selectedExams = d.selectedExams || []; findingsState = d.findingsState || {}; if(selectedExams.length > 0) renderExamSelection(); }}

function masterReset() {
    if (confirm("Isso limpará TODOS os dados da sessão e também TODOS os seus exames e achados customizados salvos neste navegador. Deseja continuar?")) {
        sessionStorage.clear();
        localStorage.clear();
        alert('Todos os dados foram limpos. A página será recarregada.');
        window.location.reload();
    }
}

function exportData() { const blob = new Blob([JSON.stringify({ customExams, customAdditions, likelihoodData }, null, 2)], { type: "application/json" }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = 'laudos_config.json'; a.click(); }
function handleImport(file) { const r = new FileReader(); r.onload = () => { try { const d = JSON.parse(r.result); if (d.customExams) customExams = d.customExams; if (d.customAdditions) customAdditions = d.customAdditions; if(d.likelihoodData) likelihoodData = d.likelihoodData; saveCustomData(); renderExamSelection(); alert('Importado!'); } catch { alert('Arquivo inválido.'); } }; r.readAsText(file); }


function updateFindingModalUI() {
    const type = document.getElementById('findingType').value;
    const answersGroup = document.getElementById('answersGroup');
    const reportLabelGroup = document.getElementById('reportLabelGroup');

    if (type === 'open-text') {
        answersGroup.classList.add('hidden');
        reportLabelGroup.classList.remove('hidden');
    } else {
        answersGroup.classList.remove('hidden');
        reportLabelGroup.classList.add('hidden');
    }
}

function positionPreviewToggle() {
  const panel = document.getElementById('previewPanel');
  const btn = document.getElementById('togglePreviewBtn');
  if (!panel || !btn) return;

  const rootStyles = getComputedStyle(document.documentElement);
  const panelWidth = parseInt(rootStyles.getPropertyValue('--panel-width')) || 300;
  const panelOffset = parseInt(rootStyles.getPropertyValue('--panel-offset-right')) || 20;
  const screen2IsActive = document.getElementById('screen2').classList.contains('active');

  if (!screen2IsActive) {
    btn.classList.add('collapse-edge');
    btn.style.right = `${panelOffset}px`;
    return;
  }

  if (panel.classList.contains('collapsed')) {
    btn.classList.add('collapse-edge');
    btn.style.right = `${panelOffset}px`;
  } else {
    btn.classList.remove('collapse-edge');
    btn.style.right = `${panelOffset + panelWidth + 8}px`;
  }
}

function togglePreviewPanel() {
  const panel = document.getElementById('previewPanel');
  const btn = document.getElementById('togglePreviewBtn');

  panel.classList.toggle('collapsed');

  if (panel.classList.contains('collapsed')) {
    btn.textContent = '«';
    btn.title = 'Mostrar pré-visualização';
  } else {
    btn.textContent = '»';
    btn.title = 'Ocultar pré-visualização';
  }
  positionPreviewToggle();
}

// COLE ESTA NOVA FUNÇÃO INTEIRA NO SEU SCRIPT
function reorderFindings(items) {
    if (!items || items.length === 0) {
        return [];
    }

    const itemMap = new Map(items.map(item => [item.id, item]));
    const childrenMap = new Map();
    const rootItems = [];

    // Primeira passagem: separa os itens raiz e mapeia os filhos de cada pai
    for (const item of items) {
        if (item.displayCondition) {
            const parentId = item.displayCondition.triggerFindingId;
            if (!childrenMap.has(parentId)) {
                childrenMap.set(parentId, []);
            }
            childrenMap.get(parentId).push(item);
        } else {
            rootItems.push(item);
        }
    }

    const result = [];
    
    // Função recursiva para adicionar um item e todos os seus descendentes
    function addWithChildren(item) {
        result.push(item);
        const children = childrenMap.get(item.id);
        if (children) {
            for (const child of children) {
                // Adiciona apenas se o filho existir no mapa original (segurança)
                if (itemMap.has(child.id)) {
                    addWithChildren(child);
                }
            }
        }
    }

    // Processa todos os itens raiz para construir a lista final
    for (const root of rootItems) {
        addWithChildren(root);
    }

    return result;
}

// ======== UX ========
window.onclick = (e) => { 
    if (e.target.classList.contains('modal')) {
        // Encontra o botão de fechar dentro do modal e o clica
        const closeBtn = e.target.querySelector('.close');
        if(closeBtn) closeBtn.click();
    }
};
window.addEventListener('beforeunload', () => { if (selectedExams.length > 0) saveSessionState(); });

</script>
</body>
</html>