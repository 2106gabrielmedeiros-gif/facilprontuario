<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário Fácil - Escalas Médicas</title>
    <style>
        :root {
		  --panel-width: 300px;
          --panel-offset-right: 20px;
          --cor-fundo: #f8f9fa;
          --cor-superficie: #ffffff;
            --cor-fundo: #f8f9fa;
            --cor-superficie: #ffffff;
            --cor-borda: #dee2e6;
            --cor-texto-principal: #212529;
            --cor-texto-secundario: #6c757d;
            --cor-primaria: #007bff;
            --cor-primaria-hover: #0056b3;
            --cor-sucesso: #28a745;
            --cor-perigo: #dc3545;
            --cor-cabecalho: #343a40;
            --sombra-suave: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background-color:var(--cor-fundo);color:var(--cor-texto-principal);line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:linear-gradient(135deg,#343a40,#495057);color:#fff;padding:30px 20px;text-align:center;margin-bottom:30px;border-radius:12px;position:relative;box-shadow:var(--sombra-suave)}
        .header h1{font-size:2.2rem;margin-bottom:10px;font-weight:700}
        .header p{font-size:1.1rem;opacity:.9}
        .header-actions {
            position: absolute;
            left: 16px;
            right: 16px;
            top: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .screen{display:none;background:var(--cor-superficie);padding:30px;border-radius:12px;box-shadow:var(--sombra-suave)}
        .screen.active{display:block}
        .exam-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
        .exam-card{border:1px solid var(--cor-borda);border-radius:12px;padding:25px;cursor:pointer;transition:all .2s ease-in-out;background-color:var(--cor-superficie);position:relative}
        .exam-card:hover{border-color:var(--cor-primaria);transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1)}
        .exam-card.selected{border-color:var(--cor-sucesso);background-color:#f0fff4;box-shadow:0 0 0 2px rgba(40,167,69,.25)}
        .exam-card h3{color:var(--cor-texto-principal);margin-bottom:10px;font-size:1.2rem;font-weight:600}
        .exam-card p{color:var(--cor-texto-secundario);font-size:.9rem}
        .exam-actions{position:absolute;top:15px;right:15px;display:flex;gap:8px}
        .icon-btn{width:30px;height:30px;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;background:#e9ecef}
        .icon-btn:hover{transform:scale(1.1)}
        .icon-btn.delete{background-color:var(--cor-perigo);color:#fff}
        .icon-btn.edit{background-color:#f39c12;color:#fff}
        .icon-btn.settings{background-color:#17a2b8;color:#fff}
        .system-section{margin-bottom:30px;border:1px solid var(--cor-borda);border-radius:12px;overflow:hidden;box-shadow:var(--sombra-suave)}
        .system-header{background-color:var(--cor-cabecalho);color:#fff;padding:15px 20px;font-weight:700;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center}
        .finding-group{background-color:#fff;padding:15px 20px;border-bottom:1px solid var(--cor-borda)}
        .finding-group:last-child{border-bottom:none}
        .finding-group h4{color:var(--cor-texto-principal);margin-bottom:10px;font-size:1.1rem;font-weight:600}
        .finding-item{padding:15px 0;border-bottom:1px solid #f0f0f0}
        .finding-item:last-child{border-bottom:none}
		.finding-question { font-weight: 500; font-size: 1rem; }
        .finding-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
        .toggle-button{padding:8px 16px;border:1px solid var(--cor-borda);background-color:var(--cor-superficie);border-radius:8px;cursor:pointer;transition:all .2s ease;font-size:.9rem;font-weight:500}
        .toggle-button:hover{border-color:var(--cor-texto-secundario);background-color:#f1f3f5}
        .toggle-button.active{background-color:var(--cor-sucesso);border-color:var(--cor-sucesso);color:#fff;font-weight:600}
        .button-group{display:flex;gap:15px;margin-top:30px;justify-content:center}
        .btn{padding:12px 30px;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:all .2s ease;font-weight:600;letter-spacing:.5px}
        .btn:hover{transform:translateY(-2px);box-shadow:var(--sombra-suave)}
        .btn-primary{background-color:var(--cor-primaria);color:#fff}
        .btn-primary:hover{background-color:var(--cor-primaria-hover)}
        .btn-secondary{background-color:var(--cor-texto-secundario);color:#fff}
        .btn-success{background-color:var(--cor-sucesso);color:#fff}
        .btn-danger{background-color:var(--cor-perigo);color:#fff}
        .btn-small{padding:6px 12px;font-size:.8rem}
        .result-area{background-color:#f8f9fa;border:1px solid var(--cor-borda);border-radius:8px;padding:20px;margin:20px 0;font-family:'Courier New',monospace;line-height:1.8;white-space:pre-wrap;max-height:400px;overflow-y:auto}
        .preview-panel{position:fixed;right:20px;top:120px;width:300px;background:var(--cor-superficie);border:1px solid var(--cor-borda);border-radius:12px;padding:20px;box-shadow:var(--sombra-suave);max-height:500px;overflow-y:auto}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:5px;font-weight:500}
        .form-group input,.form-group textarea{width:100%;padding:10px;border:1px solid var(--cor-borda);border-radius:8px;font-size:1rem;transition:all .2s ease}
        .form-group input:focus,.form-group textarea:focus{border-color:var(--cor-primaria);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}
        .hidden{display:none}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);animation:fadeIn .3s ease}
        .modal-content{background-color:var(--cor-superficie);margin:5% auto;padding:30px;border-radius:12px;width:80%;max-width:600px;max-height:80vh;overflow-y:auto;animation:slideIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .close{font-size:28px;font-weight:700;cursor:pointer;color:#aaa}
        .interpretation-rule{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:10px;align-items:center;margin-bottom:10px}
		


/* ======================= ADICIONE ESTE ESTILO ======================= */
.question-explanation {
    font-size: 0.9rem;
    color: var(--cor-texto-secundario);
    margin-top: 8px;
    padding-left: 10px;
    border-left: 3px solid #e9ecef;
}
/* ==================================================================== */

/* Adicione este estilo junto com os outros */
.instructions-box {
    background-color: #f8f9fa;
    border-left: 5px solid var(--cor-primaria);
    padding: 15px 20px;
    border-radius: 8px;
    color: var(--cor-texto-secundario);
}
.instructions-box h4 {
    color: var(--cor-texto-principal);
    margin-top: 0;
    margin-bottom: 10px;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Prontuário Fácil - Escalas Médicas</h1>
            <p>Aplique escalas com cálculo automático de pontuação.</p>
           <div class="header-actions">
                <div></div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-small" onclick="exportData()">Exportar</button>
                    <label class="btn btn-secondary btn-small" style="display:inline-flex;align-items:center;cursor:pointer">Importar<input type="file" accept="application/json" onchange="handleImport(this.files[0])" style="display:none"></label>
                    <button class="btn btn-danger btn-small" onclick="masterReset()">Reset Total</button>
                </div>
            </div>
        </div>

        <div id="screen1" class="screen active">
            <h2>Selecione a Escala</h2>
            <div class="form-group" style="margin-bottom:20px"><input type="text" id="scaleSearchInput" onkeyup="renderScaleSelection()" placeholder="Buscar escala por nome..."></div>
            <div class="exam-grid" id="scaleGrid"></div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="proceedToScale()">Prosseguir</button>
                <button class="btn btn-secondary" onclick="toggleAddScaleForm()">Adicionar Nova Escala</button>
            </div>
<div id="addScaleForm" class="add-exam-form hidden">
<div class="form-group" style="display: flex; align-items: center; gap: 10px; justify-content: start;">
    <input type="checkbox" id="newScaleProgressive" style="width: auto; height: auto;">
    <label for="newScaleProgressive" style="margin-bottom: 0; font-weight: normal;">Esta é uma escala progressiva (lógica do "último sim", tipo PPS)</label>
</div>
    <h3 id="scaleFormTitle">Adicionar Nova Escala</h3>
    <div class="form-group">
        <label for="newScaleName">Nome da Escala:</label>
        <input type="text" id="newScaleName">
    </div>
    <div class="form-group">
        <label for="newScaleDescription">Descrição Curta (para o card de seleção):</label>
        <input type="text" id="newScaleDescription" placeholder="Um resumo breve da escala...">
    </div>
    <div class="form-group">
        <label for="newScaleInstructions">Instruções de Preenchimento (para a tela da escala):</label>
        <textarea id="newScaleInstructions" rows="5" placeholder="Insira aqui as instruções detalhadas, objetivos, ou referências da escala..."></textarea>
    </div>
    <div class="button-group">
        <button id="saveScaleBtn" class="btn btn-success" onclick="addNewScale()">Adicionar</button>
        <button class="btn btn-secondary" onclick="toggleAddScaleForm()">Cancelar</button>
    </div>
</div>
        </div>

        <div id="screen2" class="screen">
            <h2>Responda as Perguntas</h2>
			    <div id="scaleInstructionsContainer" style="margin-bottom: 25px;"></div>
    <div id="questionsContainer"></div>
    <div class="button-group">
        <button class="btn btn-secondary" onclick="backToSelection()">Voltar</button>
        <button class="btn btn-primary" onclick="generateReport()">Gerar Resultado</button>
    </div>
  
            <div id="previewPanel" class="preview-panel">
                <h3>Pré-visualização do Resultado</h3>
                <div id="previewContent">Selecione as respostas...</div>
            </div>
        </div>

        <div id="screen3" class="screen">
            <h2>Resultado da Escala</h2>
            <div id="resultArea" class="result-area"></div>
            <div class="button-group"><button class="btn btn-success" onclick="copyToClipboard()">Copiar</button><button class="btn btn-primary" onclick="startNew()">Nova Avaliação</button></div>
        </div>
    </div>

<div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="questionModalTitle">Adicionar/Editar Pergunta</h3><span class="close" onclick="closeQuestionModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="questionText">Pergunta:</label>
                <input type="text" id="questionText" placeholder="Ex: Paciente apresenta febre?">
            </div>
            <div class="form-group">
                <label for="questionExplanation">Explicação (Opcional):</label>
                <textarea id="questionExplanation" rows="3" placeholder="Descreva o que a pergunta avalia ou forneça contexto adicional..."></textarea>
            </div>
            <div class="form-group">
                <label>Respostas Possíveis:</label>
                <div id="answersContainer"></div>
                <button class="btn btn-secondary btn-small" onclick="addAnswerField()" style="margin-top:10px">+ Adicionar Resposta</button>
            </div>
            <div class="button-group">
                <button id="saveQuestionBtn" class="btn btn-success">Salvar</button>
                <button class="btn btn-secondary" onclick="closeQuestionModal()">Cancelar</button>
            </div>
        </div>
    </div>
   

    <div id="scaleSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="scaleSettingsModalTitle">Configurar Interpretação da Escala</h3><span class="close" onclick="closeScaleSettingsModal()">&times;</span></div>
            <p style="color: var(--cor-texto-secundario); margin-bottom: 20px;">Defina as faixas de pontuação e o texto de resultado correspondente.</p>
            <div class="form-group">
                <label>Regras de Interpretação:</label>
                <div class="interpretation-rule" style="font-weight: bold;">
                    <span>De (pontos)</span>
                    <span>Até (pontos)</span>
                    <span>Texto da Interpretação</span>
                    <span></span>
                </div>
                <div id="interpretationsContainer"></div>
                <button class="btn btn-secondary btn-small" onclick="addInterpretationRule()" style="margin-top:10px">+ Adicionar Faixa</button>
            </div>
            <div class="button-group">
                <button id="saveScaleSettingsBtn" class="btn btn-success">Salvar Configurações</button>
                <button class="btn btn-secondary" onclick="closeScaleSettingsModal()">Cancelar</button>
            </div>
        </div>
    </div>

<script src="escalasNativas.js"></script>

<script>
// ======== ESTADO DA APLICAÇÃO ========
let selectedScales = [];
let answersState = {};
let customScales = {};

// ======== INICIALIZAÇÃO ========
document.addEventListener('DOMContentLoaded', function() {
    loadCustomData();
    renderScaleSelection();
    loadSessionState();
});

// ======== NAVEGAÇÃO E LÓGICA DE TELAS ========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// CÓDIGO CORRIGIDO
function proceedToScale() {
    if (selectedScales.length === 0) {
        alert('Selecione pelo menos uma escala.');
        return;
    }
    // Limpa as respostas da avaliação anterior
    answersState = {}; 

    renderQuestions();
    showScreen('screen2');
}

function backToSelection() {
    showScreen('screen1');
}

function generateReport() {
    const resultText = calculateScoreAndInterpret();
    const formattedResult = resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    document.getElementById('resultArea').innerHTML = formattedResult;
    showScreen('screen3');
}

function startNew() {
    sessionStorage.removeItem('sessionState');
    selectedScales = [];
    answersState = {};
    showScreen('screen1');
    renderScaleSelection();
}

function copyToClipboard() {
    const textToCopy = document.getElementById('resultArea').innerText;
    navigator.clipboard.writeText(textToCopy).then(() => alert('Resultado copiado para a área de transferência!'));
}

// ======== LÓGICA DE DADOS (MERGE E BUSCA) ========
function getMergedScales() {
    return { ...scalesData, ...customScales };
}

function findQuestionById(questionId) {
    const allScales = getMergedScales();
    for (const scale of Object.values(allScales)) {
        const question = (scale.questions || []).find(q => q.id === questionId);
        if (question) return question;
    }
    return null;
}

// ======== TELA 1: SELEÇÃO DE ESCALAS ========
// ======== TELA 1: SELEÇÃO DE ESCALAS ========
// ======== TELA 1: SELEÇÃO DE ESCALAS ========
function renderScaleSelection() {
    const grid = document.getElementById('scaleGrid');
    grid.innerHTML = '';
    const allScales = getMergedScales();
    const filterText = (document.getElementById('scaleSearchInput')?.value || '').toLowerCase();
    
    // LÓGICA DE FILTRO MAIS SEGURA: Verifica se 'scale.name' existe
    const filtered = Object.values(allScales).filter(scale => 
        scale && scale.name && scale.name.toLowerCase().includes(filterText)
    );

    filtered.forEach(scale => {
        const card = document.createElement('div');
        card.className = 'exam-card';
        if (selectedScales.includes(scale.id)) card.classList.add('selected');
        const isCustom = scale.id.startsWith('custom_');
        
        // LÓGICA DE RENDERIZAÇÃO MAIS SEGURA: Usa valores padrão caso a descrição falte
        const scaleName = scale.name || 'Nome Inválido';
        const scaleDescription = scale.description || 'Sem descrição.';
        
        card.innerHTML = `<h3>${scaleName}</h3><p>${scaleDescription}</p>
        <div class="exam-actions">
            ${isCustom ? `<button class="icon-btn settings" onclick="openScaleSettingsModal('${scale.id}')" title="Configurar Interpretação">⚙️</button>
                         <button class="icon-btn edit" onclick="openEditScaleForm('${scale.id}')" title="Editar Nome/Descrição">✎</button>
                         <button class="icon-btn delete" onclick="deleteScale('${scale.id}')" title="Deletar Escala">×</button>` : ''}
        </div>`;
        
        card.onclick = (e) => { 
            if (!e.target.closest('.exam-actions')) {
                toggleScaleSelection(scale.id);
            }
        };
        grid.appendChild(card);
    });
}
function toggleScaleSelection(scaleId) {
    selectedScales = [scaleId]; // Apenas uma escala por vez
    renderScaleSelection();
}

// ======== LÓGICA DO FORMULÁRIO DE ESCALAS (ADICIONAR/EDITAR) ========
function toggleAddScaleForm() {
    const form = document.getElementById('addScaleForm');
    form.classList.toggle('hidden');
    if (!form.classList.contains('hidden')) {
        // Reseta o formulário para o modo de adição
        document.getElementById('scaleFormTitle').textContent = 'Adicionar Nova Escala';
        document.getElementById('newScaleName').value = '';
        document.getElementById('newScaleDescription').value = '';
        document.getElementById('newScaleInstructions').value = '';
        document.getElementById('newScaleProgressive').checked = false; // Limpa o checkbox
        const saveBtn = document.getElementById('saveScaleBtn');
        saveBtn.textContent = 'Adicionar';
        saveBtn.onclick = addNewScale; 
    }
}

function addNewScale() {
    const name = document.getElementById('newScaleName').value.trim();
    const desc = document.getElementById('newScaleDescription').value.trim();
    const instructions = document.getElementById('newScaleInstructions').value.trim();
    const isProgressive = document.getElementById('newScaleProgressive').checked;

    if (!name || !desc) {
        alert("O Nome e a Descrição Curta são obrigatórios.");
        return;
    }

    const newId = 'custom_' + Date.now();
    customScales[newId] = {
        id: newId,
        name: name,
        description: desc,
        instructions: instructions,
        progressive: isProgressive,
        questions: [],
        interpretations: []
    };
    
    selectedScales = [newId];

    saveCustomData();
    toggleAddScaleForm(); 
    renderScaleSelection(); 
}

function openEditScaleForm(scaleId) {
    const scale = customScales[scaleId];
    if (!scale) return;

    // Preenche o formulário com os dados da escala existente
    document.getElementById('newScaleName').value = scale.name;
    document.getElementById('newScaleDescription').value = scale.description;
    document.getElementById('newScaleInstructions').value = scale.instructions || '';
    document.getElementById('newScaleProgressive').checked = scale.progressive || false; // Define o estado do checkbox

    // Ajusta o título e o botão para o modo de edição
    document.getElementById('scaleFormTitle').textContent = 'Editar Escala';
    const saveBtn = document.getElementById('saveScaleBtn');
    saveBtn.textContent = 'Salvar Alterações';
    saveBtn.onclick = () => saveScaleChanges(scaleId);

    // Exibe o formulário
    const form = document.getElementById('addScaleForm');
    form.classList.remove('hidden');
}

// ======== TELA 2: RENDERIZAÇÃO DAS PERGUNTAS ========
// ======== TELA 2: RENDERIZAÇÃO DAS PERGUNTAS ========
function renderQuestions() {
    const instructionsContainer = document.getElementById('scaleInstructionsContainer');
    const questionsContainer = document.getElementById('questionsContainer');
    instructionsContainer.innerHTML = '';
    questionsContainer.innerHTML = '';

    const scaleId = selectedScales[0];
    const scale = getMergedScales()[scaleId];

    if (scale && scale.instructions) {
        const instructionsBox = document.createElement('div');
        instructionsBox.className = 'instructions-box';
        // LÓGICA SIMPLIFICADA: Apenas mostra as instruções como estão.
        instructionsBox.innerHTML = `<h4>Instruções</h4><p>${scale.instructions.replace(/\n/g, '<br>')}</p>`;
        instructionsContainer.appendChild(instructionsBox);
    }

    selectedScales.forEach(scaleId => {
        const scale = getMergedScales()[scaleId];
        if (!scale) return;
        const isCustomScale = scale.id.startsWith('custom_');

        const systemSection = document.createElement('div');
        systemSection.className = 'system-section';
        const header = document.createElement('div');
        header.className = 'system-header';
        header.innerHTML = `${scale.name}
            <div class="system-actions">
                ${isCustomScale ? `<button class="btn btn-success btn-small" onclick="openQuestionModal('${scaleId}')">+ Pergunta</button>` : ''}
            </div>`;
        systemSection.appendChild(header);

        const groupDiv = document.createElement('div');
        groupDiv.className = 'finding-group';

        (scale.questions || []).forEach(question => {
            const stateObj = answersState[question.id];
            const findingWrapper = document.createElement('div');
            findingWrapper.className = 'finding-item';
            findingWrapper.id = `question-item-${question.id}`;

            const questionDiv = document.createElement('div');
            questionDiv.className = 'finding-question';
            questionDiv.textContent = question.question;
            findingWrapper.appendChild(questionDiv);

            if (question.explanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'question-explanation';
                explanationDiv.textContent = question.explanation;
                findingWrapper.appendChild(explanationDiv);
            }

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'finding-controls';

            (question.answers || []).forEach(answer => {
                const btn = document.createElement('button');
                btn.className = 'toggle-button';
                btn.textContent = answer.text;
                if (stateObj && stateObj.answerId === answer.id) {
                    btn.classList.add('active');
                }
                btn.onclick = () => selectAnswer(question.id, answer.id);
                controlsDiv.appendChild(btn);
            });
            
            const editBtn = document.createElement('button');
            editBtn.className = 'icon-btn edit';
            editBtn.innerHTML = '✎';
            editBtn.title = 'Editar pergunta';
            editBtn.onclick = () => openEditQuestionModal(scale.id, question.id);
            controlsDiv.appendChild(editBtn);
            
            findingWrapper.appendChild(controlsDiv);
            groupDiv.appendChild(findingWrapper);
        });
        systemSection.appendChild(groupDiv);
        questionsContainer.appendChild(systemSection);
    });
    updatePreview();
}

// ======== LÓGICA DO PAINEL DE PRÉ-VISUALIZAÇÃO ========
function updatePreview() {
    const previewContent = document.getElementById('previewContent');
    if (selectedScales.length === 0) {
        previewContent.innerHTML = 'Selecione uma escala...';
        return;
    }

    // Verifica se alguma resposta foi dada
    const hasAnswers = Object.keys(answersState).length > 0;
    if (!hasAnswers) {
         previewContent.innerHTML = 'Selecione as respostas...';
         return;
    }

    const resultText = calculateScoreAndInterpret();
    // Formata o texto para exibição, convertendo quebras de linha em <br> e **texto** em <strong>
    const formattedResult = resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    previewContent.innerHTML = formattedResult;
}


function selectAnswer(questionId, answerId) {
    const currentState = answersState[questionId];
    if (currentState && currentState.answerId === answerId) {
        delete answersState[questionId];
    } else {
        answersState[questionId] = { answerId: answerId };
    }
    renderQuestions();
}

// ======== LÓGICA DE PONTUAÇÃO E INTERPRETAÇÃO ========
// Substitua a função inteira por esta:
function calculateScoreAndInterpret() {
    if (selectedScales.length === 0) return 'Nenhuma escala selecionada.';

    const scaleId = selectedScales[0];
    const scale = getMergedScales()[scaleId];
    if (!scale) return 'Erro: Escala não encontrada.';

    // LÓGICA ATUALIZADA: Verifica a propriedade booleana 'progressive'
    const isProgressive = scale.progressive === true;

    if (isProgressive) {
        // ======================= INÍCIO DA ALTERAÇÃO =======================
        let lastSimQuestionText = "Nenhum critério foi atendido.";
        const questions = scale.questions || [];

        // A nova lógica percorre TODAS as perguntas sem interrupção.
        for (const question of questions) {
            const answerState = answersState[question.id];
            
            // Verifica se a pergunta foi respondida
            if (answerState) {
                const answer = question.answers.find(a => a.id === answerState.answerId);
                
                // Se a resposta tiver pontos > 0, ATUALIZA o texto.
                // Ele não para mais, apenas sobrescreve com o último valor positivo encontrado.
                if (answer && answer.points > 0) {
                    lastSimQuestionText = question.question;
                }
            }
        }
        
        return `**${scale.name}**\n\n**Nível Atingido:**\n${lastSimQuestionText}`;
        // ======================== FIM DA ALTERAÇÃO =========================

    } else {
        // LÓGICA ANTIGA (SOMA DE PONTOS) - Permanece inalterada
        let totalScore = 0;
        for (const questionId in answersState) {
            const question = findQuestionById(questionId);
            if (question) {
                const answerId = answersState[questionId].answerId;
                const answer = question.answers.find(a => a.id === answerId);
                if (answer) {
                    totalScore += answer.points;
                }
            }
        }

        let interpretationText = "Faixa de interpretação não definida para esta pontuação.";
        if (scale.interpretations) {
            for (const rule of scale.interpretations) {
                if (totalScore >= rule.min && totalScore <= rule.max) {
                    interpretationText = rule.text;
                    break;
                }
            }
        }	
        
        if (scale.id === 'pps_1758045265186') {
    // Se for, retorna o texto sem a pontuação
    return `**${scale.name}**\n\n**Interpretação:**\n${interpretationText}`;
} else {
    // Para todas as outras escalas, retorna o texto com a pontuação
    return `**${scale.name}**\n\n**Pontuação Final:** ${totalScore}\n\n**Interpretação:**\n${interpretationText}`;
}
    }
}

function saveScaleChanges(scaleId) {
    const name = document.getElementById('newScaleName').value.trim();
    const desc = document.getElementById('newScaleDescription').value.trim();
    const instructions = document.getElementById('newScaleInstructions').value.trim();
    const isProgressive = document.getElementById('newScaleProgressive').checked; // Captura a alteração

    if (!name || !desc) return alert("O Nome e a Descrição Curta são obrigatórios.");

    customScales[scaleId].name = name;
    customScales[scaleId].description = desc;
    customScales[scaleId].instructions = instructions;
    customScales[scaleId].progressive = isProgressive; // Salva a alteração
    saveCustomData();
    toggleAddScaleForm();
    renderScaleSelection();
}

function deleteScale(scaleId) {
    if (confirm('Tem certeza que deseja deletar esta escala e todas as suas perguntas?')) {
        delete customScales[scaleId];
        selectedScales = selectedScales.filter(id => id !== scaleId);
        saveCustomData();
        renderScaleSelection();
    }
}

// Modal de Perguntas
function addAnswerField(text = '', points = 0) {
    const container = document.getElementById('answersContainer');
    const div = document.createElement('div');
    div.className = 'answer-input-group';
    div.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px;';
    const textInput = document.createElement('input');
    textInput.type = 'text'; textInput.value = text; textInput.placeholder = 'Texto da Resposta'; textInput.className = 'answer-text';
    const pointsInput = document.createElement('input');
    pointsInput.type = 'number'; pointsInput.value = points; pointsInput.placeholder = 'Pontos'; pointsInput.className = 'answer-points';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn-danger btn-small'; removeBtn.textContent = '×';
    removeBtn.onclick = () => div.remove();
    div.appendChild(textInput); div.appendChild(pointsInput); div.appendChild(removeBtn);
    container.appendChild(div);
}

function openQuestionModal(scaleId) {
    const modal = document.getElementById('questionModal');
    document.getElementById('questionModalTitle').textContent = 'Adicionar Nova Pergunta';
    document.getElementById('questionText').value = '';
    // NOVO: Limpa o campo de explicação
    document.getElementById('questionExplanation').value = ''; 
    document.getElementById('answersContainer').innerHTML = '';
    addAnswerField('Sim', 1);
    addAnswerField('Não', 0);
    document.getElementById('saveQuestionBtn').onclick = () => saveQuestion(scaleId);
    modal.style.display = 'block';
}

function openEditQuestionModal(scaleId, questionId) {
    const question = findQuestionById(questionId);
    if (!question) return;
    const modal = document.getElementById('questionModal');
    document.getElementById('questionModalTitle').textContent = 'Editar Pergunta';
    document.getElementById('questionText').value = question.question;
    // NOVO: Preenche o campo de explicação com o valor salvo
    document.getElementById('questionExplanation').value = question.explanation || '';
    const answersContainer = document.getElementById('answersContainer');
    answersContainer.innerHTML = '';
    (question.answers || []).forEach(ans => addAnswerField(ans.text, ans.points));
    document.getElementById('saveQuestionBtn').onclick = () => saveQuestionChanges(scaleId, questionId);
    modal.style.display = 'block';
}

function closeQuestionModal() {
    document.getElementById('questionModal').style.display = 'none';
}

function saveQuestion(scaleId) {
    const questionText = document.getElementById('questionText').value.trim();
    // NOVO: Pega o valor da explicação
    const explanationText = document.getElementById('questionExplanation').value.trim(); 
    
    if (!questionText) return alert('O texto da pergunta é obrigatório.');

    const answerGroups = document.querySelectorAll('#answersContainer .answer-input-group');
    const answers = Array.from(answerGroups).map(div => ({
        id: `ans_${Date.now()}_${Math.random()}`,
        text: div.querySelector('.answer-text').value.trim(),
        points: parseFloat(div.querySelector('.answer-points').value) || 0
    })).filter(ans => ans.text);

    if (answers.length === 0) return alert('Adicione pelo menos uma resposta.');

    // NOVO: Adiciona a propriedade 'explanation' ao objeto da nova pergunta
    const newQuestion = { 
        id: 'custom_q_' + Date.now(), 
        question: questionText, 
        explanation: explanationText, 
        answers 
    };
    customScales[scaleId].questions.push(newQuestion);
    saveCustomData();
    closeQuestionModal();
    renderQuestions();
}


function saveQuestionChanges(scaleId, questionId) {
    const question = findQuestionById(questionId);
    if (!question) return;
    question.question = document.getElementById('questionText').value.trim();
    // NOVO: Salva a explicação no objeto da pergunta
    question.explanation = document.getElementById('questionExplanation').value.trim(); 
    
    const answerGroups = document.querySelectorAll('#answersContainer .answer-input-group');
    const answers = Array.from(answerGroups).map(div => ({
        id: `ans_${Date.now()}_${Math.random()}`,
        text: div.querySelector('.answer-text').value.trim(),
        points: parseFloat(div.querySelector('.answer-points').value) || 0
    })).filter(ans => ans.text);
    
    question.answers = answers;
    saveCustomData();
    closeQuestionModal();
    renderQuestions();
}

// Modal de Configurações da Escala
function openScaleSettingsModal(scaleId) {
    const scale = customScales[scaleId];
    if (!scale) return;
    const modal = document.getElementById('scaleSettingsModal');
    document.getElementById('scaleSettingsModalTitle').textContent = `Configurar Escala: ${scale.name}`;
    const container = document.getElementById('interpretationsContainer');
    container.innerHTML = '';
    (scale.interpretations || []).forEach(rule => addInterpretationRule(rule.min, rule.max, rule.text));
    document.getElementById('saveScaleSettingsBtn').onclick = () => saveScaleSettings(scaleId);
    modal.style.display = 'block';
}

function closeScaleSettingsModal() {
    document.getElementById('scaleSettingsModal').style.display = 'none';
}

function addInterpretationRule(min = 0, max = 0, text = '') {
    const container = document.getElementById('interpretationsContainer');
    const div = document.createElement('div');
    div.className = 'interpretation-rule';
    div.innerHTML = `
        <input type="number" class="interp-min" value="${min}" placeholder="De">
        <input type="number" class="interp-max" value="${max}" placeholder="Até">
        <input type="text" class="interp-text" value="${text}" placeholder="Texto da interpretação">
        <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">×</button>
    `;
    container.appendChild(div);
}

function saveScaleSettings(scaleId) {
    const scale = customScales[scaleId];
    if (!scale) return;
    const rules = [];
    const ruleElements = document.querySelectorAll('#interpretationsContainer .interpretation-rule');
    ruleElements.forEach(el => {
        const min = parseFloat(el.querySelector('.interp-min').value);
        const max = parseFloat(el.querySelector('.interp-max').value);
        const text = el.querySelector('.interp-text').value.trim();
        if (!isNaN(min) && !isNaN(max) && text) {
            rules.push({ min, max, text });
        }
    });
    scale.interpretations = rules;
    saveCustomData();
    closeScaleSettingsModal();
}

// ======== PERSISTÊNCIA ========
function saveCustomData() {
    localStorage.setItem('customScales', JSON.stringify(customScales));
}

function loadCustomData() {
    const cs = localStorage.getItem('customScales');
    if (cs) customScales = JSON.parse(cs);
}

function saveSessionState() {
    sessionStorage.setItem('sessionState', JSON.stringify({ selectedScales, answersState }));
}

function loadSessionState() {
    const s = sessionStorage.getItem('sessionState');
    if (s) {
        const d = JSON.parse(s);
        selectedScales = d.selectedScales || [];
        answersState = d.answersState || {};
        if (selectedScales.length > 0) renderScaleSelection();
    }
}

function masterReset() {
    if (confirm("Isso limpará TODOS os dados da sessão e também TODAS as suas escalas customizadas salvas neste navegador. Deseja continuar?")) {
        sessionStorage.clear();
        localStorage.clear();
        alert('Todos os dados foram limpos. A página será recarregada.');
        window.location.reload();
    }
}

function exportData() {
    const blob = new Blob([JSON.stringify({ customScales }, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `escalas_config_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

function handleImport(file) {
    const r = new FileReader();
    r.onload = () => {
        try {
            const d = JSON.parse(r.result);
            if (d.customScales) {
                customScales = { ...customScales, ...d.customScales };
                saveCustomData();
                renderScaleSelection();
                alert('Escalas importadas com sucesso!');
            } else {
                alert('Arquivo inválido: nenhuma escala encontrada.');
            }
        } catch {
            alert('Erro ao ler o arquivo. Verifique se é um JSON válido.');
        }
    };
    r.readAsText(file);
}

// ======== UX ========
window.onclick = (e) => {
    if (e.target.classList.contains('modal')) {
        const closeBtn = e.target.querySelector('.close');
        if(closeBtn) closeBtn.click();
    }
};
window.addEventListener('beforeunload', saveSessionState);

</script>
</body>
</html>